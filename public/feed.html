<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/htmx.org@1.8.6"></script>
<script src="https://unpkg.com/hyperscript.org@0.9.7"></script>
</head>

<div onclick="location.href='/'" style="position: relative; max-width: 640px; margin: auto; text-align: center; cursor: pointer;" >
    <img src="./header.svg" style="width: 640px; max-width: 100%";>
        <div class="header" style="position: absolute; top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); width: 100%;">
      <h2 style="font-weight: 400;">A cooperative social network,<br>to realize our worlds.</h2>
      <h1 style="margin-top: 15px;">groundtalk.land</h1>
      </div>
      <a href="/" class="" style="text-align: right; display: block; margin-top: 10px;">Sign up with email</a>
    </div>
<br>
    <p class="center"><em>Enter new post</em>
        <br><br>
<form class="center" style="" hx-post="/.netlify/functions/postMessage" hx-target="#feed" hx-swap="afterbegin" hx-trigger="submit" _="on htmx:afterSwap call logData(event, swap)">
    <textarea name="txt" style="width: 350px; height: 100px"></textarea>
    <!-- <p style="text-align: center;"><em>Crosspost to:</em></p> -->
    <div style="display: flex; margin-top: 10px;">
        <div class="checkbox"><input type="checkbox" value="Twitter"><label>Post to Twitter</label></div>
        <div class="checkbox"><input type="checkbox" value="Mastodon" style="margin-left: 20px;"><label>Post to Mastodon</label></div>
    </div>
<button style="margin-left: auto; display: block;">Submit</button>
</form>
<hr style="max-width: 350px; margin: 30px auto;">
<div id="feed" class="center">

</div>

<script>

    function loadCacheThenGetMessages() {

        // ts = timestamp
        // we will append this as a query parameter to the GET request, to indicate which messages (if any) to retrieve in the backend
        // because some messages may already be cached locally, as a way of lowering the amount of requests and repeated data transfers
        let ts = 0;

        if (localStorage.cache) {

            // setting the feed to all of the messages in the cache
            document.getElementById('feed').innerHTML = localStorage.cache;

            // Set the timestamp value equal to the timestamp value of the latest message in the cache.
            ts = document.getElementsByClassName("ts")[0].innerText;
        }

            const xhr = new XMLHttpRequest();

            // adding timestamp value as query parameter
            const url = `/.netlify/functions/getMessages/?ts=${ts}`

            xhr.open("GET", url);

            xhr.onload = function () {
                console.log(xhr.response);

                // appending the messages retrieved from the DB to the top of the feed
                document.getElementById('feed').innerHTML = xhr.response + document.getElementById('feed').innerHTML

                // and updating the message cache with the updated version of the feed
                localStorage.setItem('cache', document.getElementById('feed').innerHTML);
            };
            xhr.onerror = function () {
                // ...handle/report error...
            };

            xhr.send();
    }

    loadCacheThenGetMessages();

    function logData(event, swap) {
            console.log(swap);
            console.log(event);
            const xhr = event.detail.xhr;
            console.log(xhr);
    }   

//     htmx.logger = function(elt, event, data) {
//     if(console) {
//         console.log(event, elt, data);
//     }
// }

htmx.on("htmx:afterSwap", function(evt) {
    console.log(evt);
    console.log(evt.detail.requestConfig.parameters.txt);

    if (document.querySelector('input[value="Twitter"]').checked || document.querySelector('input[value="Mastodon"]').checked) {

        console.log('crosspost!')

        crosspost(evt.detail.requestConfig.parameters.txt)

    }
    // myJavascriptLib.init(evt.detail.elt);
});


//  this function below is a work-in-progress, for local automated cross-posting

// for extension when browsing other sites: css and html injection when browsing walled gardens like tiwtter and linkedin and facebook to crosspost out and mastodon


// for uploading to ground talk:
// integer pk, natural id which is url that contains post data
// gah integer pk makes sense (esp for many-to-many like replies), but for offline / local-first / distributed then uuidv7 makes sense
// automatically compress images on uploading
// choice of "upload to groundtalk"
// email notifications on daily basis
// implement replies
// show where you are posting from on groundtalk with your author id?



// authenticate groundtalk
// authenticate mastodon?


function crosspost(msg) {
    
    if (document.querySelector('input[value="Twitter"]').checked) {
        var twitter = window.open(`https://twitter.com/intent/tweet?text=${msg}`, 'twitter','width=500,height=500');

    }
    
    if (document.querySelector('input[value="Mastodon"]').checked) {
        
        let instance_url = "https://kolektiva.social"
        var mastodon = window.open(`https://kolektiva.social/share?text=${msg}`, 'mastodon','width=500,height=500');

    }
        
        // let instance_url = "https://kolektiva.social"

        // // open twitter window with post contents
        // var twitter = window.open(`https://twitter.com/intent/tweet?text=${msg}`, 'twitter','width=500,height=500');

        // var mastodon = window.open(`https://kolektiva.social/share?text=${msg}`, 'mastodon','width=500,height=500');


        // open Mastodon window with post contents

        setTimeout(function() {

        

        // twitter.document.querySelector(`[data-testid="tweetButton"] > .css-901oao > .css-901oao > .css-901oao`).click()

        // twitter.querySelector("div[data-testid='tweetButton'] > div > span > span").click();

        twitter.close();

        }, 10000)

        twitter.onload = function() {

        // var tweetInput = twitterWindow.document.querySelector('[name="tweet"]');
        // tweetInput.value = text;

        // alert('load')

        // Find the Tweet button and click it
        // var tweetButton = twitterWindow.document.querySelector('[data-testid="tweetButton"]');
        // tweetButton.click();
        }


//         function composeTweet(text) {
//   // Open a new window
//   var twitterWindow = window.open("https://twitter.com/compose/tweet", "_blank");

//   // Wait for the window to load
//   twitterWindow.onload = function() {
//     // Find the text input field and set its value
//     var tweetInput = twitterWindow.document.querySelector('[name="tweet"]');
//     tweetInput.value = text;

//     // Find the Tweet button and click it
//     var tweetButton = twitterWindow.document.querySelector('[data-testid="tweetButtonInline"]');
//     tweetButton.click();
//   };
// }

// Usage example
// composeTweet("Hello, world!");




        // alert("page fully loaded");

        // let tweetButton = null;

        // twitter.document.querySelectorAll(`data-testid[tweetButton]`)[0].onload() = (event) => {
        //     alert('hey');
        // }

        // while (tweetButton == null) {
        //     if (twitter.document.querySelectorAll(`data-testid[tweetButton]`)[0]) {
        //         twitter.console.log('not null');
        //         tweetButton = twitter.document.querySelectorAll(`data-testid[tweetButton]`)[0];
        //         twitter.alert('not null');
        //     }
        // }

        // twitter.onload = (event) => {
        //     console.log("page fully loaded");
        // };

        // twitter.addEventListener("load", (event) => {

        //     alert("page fully loaded");

        // })
    

            // twitter.document.querySelectorAll(`data-testid="tweetButton"`)[0].click
        // twitter.document.onload()

        // getElementsByClassName("public-DraftStyleDefault-block public-DraftStyleDefault-ltr")[0].innerHTML = `<span data-offset-key="fjigd-0-0"><span data-text="true">test</span></span>`

    }

// function text() {


//     // openTab().then({
//     //     function(){
//     //         twitter.document.getElementsByClassName("public-DraftStyleDefault-block public-DraftStyleDefault-ltr")[0].firstChild.click();
//     //     twitter.document.getElementsByClassName("public-DraftStyleDefault-block public-DraftStyleDefault-ltr")[0].firstChild.focus();


//     //     twitter.document.getElementsByClassName("public-DraftStyleDefault-block public-DraftStyleDefault-ltr")[0].innerHTML = `<span data-offset-key="fjigd-0-0"><span data-text="true">test</span></span>`
//     //     }
//     // })

// };

    // function replaceHTML() {
    //     twitter.document.getElementsByClassName("public-DraftStyleDefault-block public-DraftStyleDefault-ltr")[0].firstChild.click();
    //     twitter.document.getElementsByClassName("public-DraftStyleDefault-block public-DraftStyleDefault-ltr")[0].firstChild.focus();


    //     twitter.document.getElementsByClassName("public-DraftStyleDefault-block public-DraftStyleDefault-ltr")[0].innerHTML = `<span data-offset-key="fjigd-0-0"><span data-text="true">test</span></span>`

    // }
</script>

<style>
    .center {
        margin: auto;
        width: fit-content;
        display: block;
    }
    div.post {
        background: lightyellow; padding: 1em; border: solid 1px darkgrey; border-radius: 10px; width: 300px; max-width: 100%; margin-bottom: 0.75em;
    }
    p.by {
        font-weight: 600;
    }
    p.ts {
        font-style: italic;
        font-size: 12px;
    }
    @media only screen and (max-width: 600px) {

    .header h2{
      font-size: 1.3em;
      line-height: normal;
    }
    .header h1{
      font-size: 1.7em;
      line-height: normal;
      margin-top: -11px !important;
    }
  }

  .checkbox > label {
    margin-left: 5px;
  }
</style>